/*
 * tinybms_defs.h
 * DÃ©finitions protocolaires pour TinyBMS (Protocol Rev D)
 */

#ifndef TINYBMS_DEFS_H
#define TINYBMS_DEFS_H

#include <stdint.h>

// ---------------------------------------------------------
// Protocol Constants
// ---------------------------------------------------------
#define TINYBMS_START_BYTE                  0xAA
#define TINYBMS_PROTOCOL_CRC_POLY           0x8005 // x16 + x15 + x2 + 1

// ---------------------------------------------------------
// 1. Command Codes (UART)
// ---------------------------------------------------------

// --- System & Events ---
#define TINYBMS_CMD_RESET_CLEAR             0x02 // Reset/Clear
#define TINYBMS_CMD_READ_EVENTS_NEWEST      0x11 // Read Newest Events
#define TINYBMS_CMD_READ_EVENTS_ALL         0x12 // Read All Events

// --- Register Access (Proprietary) ---
#define TINYBMS_CMD_READ_REG_BLOCK          0x07 // Read Block
#define TINYBMS_CMD_READ_REG_INDIVIDUAL     0x09 // Read Individual
#define TINYBMS_CMD_WRITE_REG_BLOCK         0x0B // Write Block
#define TINYBMS_CMD_WRITE_REG_INDIVIDUAL    0x0D // Write Individual

// --- Register Access (MODBUS Compatible) ---
#define TINYBMS_CMD_MODBUS_READ_HOLDING     0x03 //
#define TINYBMS_CMD_MODBUS_WRITE_MULTI      0x10 //

// --- Live Data Shortcuts (Read Only) ---
#define TINYBMS_CMD_READ_PACK_VOLTAGE       0x14 // Reg:36
#define TINYBMS_CMD_READ_PACK_CURRENT       0x15 // Reg:38
#define TINYBMS_CMD_READ_MAX_CELL_V         0x16 // Reg:41
#define TINYBMS_CMD_READ_MIN_CELL_V         0x17 // Reg:40
#define TINYBMS_CMD_READ_ONLINE_STATUS      0x18 // Reg:50
#define TINYBMS_CMD_READ_LIFETIME_CNTR      0x19 // Reg:32
#define TINYBMS_CMD_READ_SOC                0x1A // Reg:46
#define TINYBMS_CMD_READ_TEMPS              0x1B // Reg:48, 42, 43
#define TINYBMS_CMD_READ_CELL_VOLTAGES      0x1C // All Cells
#define TINYBMS_CMD_READ_SETTINGS_INFO      0x1D // Min/Max/Default/Current
#define TINYBMS_CMD_READ_VERSION            0x1E // Basic Version
#define TINYBMS_CMD_READ_VERSION_EXT        0x1F // Extended Version
#define TINYBMS_CMD_READ_CALC_VALUES        0x20 // Speed/Dist/Time

// ---------------------------------------------------------
// 2. Register Map (Chapter 3)
// ---------------------------------------------------------

// --- Live Data ---
#define TINYBMS_REG_CELL_1_V                0
// ... (Cells 2-16 are sequential 1-15) ...
#define TINYBMS_REG_LIFETIME_COUNTER        32
#define TINYBMS_REG_ESTIMATED_TIME_LEFT     34
#define TINYBMS_REG_PACK_VOLTAGE            36
#define TINYBMS_REG_PACK_CURRENT            38
#define TINYBMS_REG_MIN_CELL_V              40
#define TINYBMS_REG_MAX_CELL_V              41
#define TINYBMS_REG_TEMP_EXT_1              42
#define TINYBMS_REG_TEMP_EXT_2              43
#define TINYBMS_REG_DIST_LEFT               44
#define TINYBMS_REG_SOH                     45
#define TINYBMS_REG_SOC                     46
#define TINYBMS_REG_TEMP_INTERNAL           48
#define TINYBMS_REG_ONLINE_STATUS           50
#define TINYBMS_REG_BALANCING_DECISION      51
#define TINYBMS_REG_REAL_BALANCING          52
#define TINYBMS_REG_NUM_CELLS               53
#define TINYBMS_REG_SPEED                   54

// --- Statistics ---
#define TINYBMS_REG_TOTAL_DISTANCE          101
#define TINYBMS_REG_MAX_DISCHARGE_I         102
#define TINYBMS_REG_MAX_CHARGE_I            103
#define TINYBMS_REG_MAX_CELL_DIFF           104
#define TINYBMS_REG_UV_COUNT                105
#define TINYBMS_REG_OV_COUNT                106
#define TINYBMS_REG_OC_DISCHARGE_COUNT      107
#define TINYBMS_REG_OC_CHARGE_COUNT         108
#define TINYBMS_REG_OVERHEAT_COUNT          109
#define TINYBMS_REG_CHARGING_COUNT          111
#define TINYBMS_REG_FULL_CHARGE_COUNT       112
#define TINYBMS_REG_MIN_PACK_TEMP           113
#define TINYBMS_REG_MAX_PACK_TEMP           114

// --- Settings (R/W) ---
#define TINYBMS_REG_CFG_FULLY_CHARGED_V     300
#define TINYBMS_REG_CFG_FULLY_DISCHARGED_V  301
#define TINYBMS_REG_CFG_EARLY_BAL_THRESH    303
#define TINYBMS_REG_CFG_CHARGE_FINISHED_I   304
#define TINYBMS_REG_CFG_PEAK_DISCHARGE_I    305
#define TINYBMS_REG_CFG_BATTERY_CAPACITY    306
#define TINYBMS_REG_CFG_SERIES_CELLS        307
#define TINYBMS_REG_CFG_ALLOWED_DISBALANCE  308
#define TINYBMS_REG_CFG_OVER_VOLTAGE_CUT    315
#define TINYBMS_REG_CFG_UNDER_VOLTAGE_CUT   316
#define TINYBMS_REG_CFG_DIS_OC_CUT          317
#define TINYBMS_REG_CFG_CHG_OC_CUT          318
#define TINYBMS_REG_CFG_OVER_HEAT_CUT       319
#define TINYBMS_REG_CFG_LOW_TEMP_CUT        320

// ---------------------------------------------------------
// 3. Enumerations & Options
// ---------------------------------------------------------

// Options for Command 0x02 (Reset)
typedef enum {
    TINYBMS_RESET_CLEAR_EVENTS = 0x01,
    TINYBMS_RESET_CLEAR_STATS  = 0x02,
    TINYBMS_RESET_REBOOT       = 0x05
} tinybms_reset_opt_t;

// Options for Command 0x1D (Settings Info)
typedef enum {
    TINYBMS_SETTINGS_MIN     = 0x01,
    TINYBMS_SETTINGS_MAX     = 0x02,
    TINYBMS_SETTINGS_DEFAULT = 0x03,
    TINYBMS_SETTINGS_CURRENT = 0x04
} tinybms_settings_opt_t;

// Online Status Flags (Reg 50 / Cmd 0x18)
#define TINYBMS_STATUS_CHARGING         0x91
#define TINYBMS_STATUS_FULLY_CHARGED    0x92
#define TINYBMS_STATUS_DISCHARGING      0x93
#define TINYBMS_STATUS_REGENERATION     0x96
#define TINYBMS_STATUS_IDLE             0x97
#define TINYBMS_STATUS_FAULT            0x9B

#endif // TINYBMS_DEFS_H
