<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuration MQTT - TinyBMS Gateway</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />

    <!-- Tabler CSS + Icons -->
    <link rel="stylesheet" href="/assets/css/tabler.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/tabler-icons.min.css" />

    <!-- Styles personnalisés -->
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="theme-dark">
    <div class="page">
      <!-- Header simple -->
      <header class="navbar navbar-expand-md navbar-dark app-header">
        <div class="container-xl">
          <div class="d-flex flex-column gap-3 w-100">
            <div class="d-flex flex-wrap align-items-center gap-3">
              <div class="app-logo">
                <div class="app-logo-icon">
                  <i class="ti ti-settings"></i>
                </div>
                <div class="app-logo-text">
                  <div class="app-logo-title">Configuration MQTT</div>
                  <div class="app-logo-subtitle">TinyBMS Gateway</div>
                </div>
              </div>
              <div class="ms-auto">
                <a href="/" class="btn btn-outline-primary">
                  <i class="ti ti-arrow-left me-2"></i>
                  Retour au Dashboard
                </a>
              </div>
            </div>
            <div
              id="mqtt-status-summary"
              class="d-flex flex-wrap align-items-center gap-3"
              aria-live="polite"
            >
              <div class="d-flex align-items-center gap-2">
                <span class="text-secondary text-uppercase small fw-semibold">Statut</span>
                <span id="mqtt-summary-state" class="badge status-badge" data-placeholder>--</span>
              </div>
              <div class="d-flex flex-column">
                <span class="text-secondary text-uppercase small fw-semibold">Dernier succès</span>
                <span id="mqtt-summary-last-success" class="fw-semibold" data-placeholder>--</span>
              </div>
              <div class="d-flex flex-column">
                <span class="text-secondary text-uppercase small fw-semibold">Firmware</span>
                <span id="mqtt-summary-firmware" class="fw-semibold" data-placeholder>--</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Main content -->
      <main class="page-body">
        <div class="container-xl">
          <div class="row g-3 mt-3">
            <!-- Status Card -->
            <div class="col-lg-4">
              <div class="card" id="mqtt-status-card">
                <div class="card-header d-flex flex-wrap align-items-center gap-2">
                  <h3 class="card-title mb-0">État du broker</h3>
                  <div class="ms-auto d-flex flex-wrap gap-2">
                    <button id="mqtt-test" class="btn btn-outline-secondary btn-sm">Tester la connexion</button>
                    <button id="mqtt-refresh" class="btn btn-outline-primary btn-sm">Actualiser</button>
                  </div>
                </div>
                <div class="card-body" id="mqtt-status-body">
                  <div class="d-flex flex-wrap align-items-center gap-3">
                    <span id="mqtt-connection-state" class="badge status-badge" data-placeholder>--</span>
                    <span id="mqtt-last-error" class="text-secondary small" aria-live="polite" data-placeholder>Aucune erreur</span>
                  </div>
                  <dl class="status-kv mt-3">
                    <div><dt>Client</dt><dd id="mqtt-client-started" data-placeholder>--</dd></div>
                    <div><dt>Wi-Fi</dt><dd id="mqtt-wifi-state" data-placeholder>--</dd></div>
                    <div><dt>Reconnexions</dt><dd id="mqtt-reconnect-count" data-placeholder>0</dd></div>
                    <div><dt>Déconnexions</dt><dd id="mqtt-disconnect-count" data-placeholder>0</dd></div>
                    <div><dt>Erreurs</dt><dd id="mqtt-error-count" data-placeholder>0</dd></div>
                    <div><dt>Dernier événement</dt><dd id="mqtt-last-event" data-placeholder>--</dd></div>
                    <div><dt>Horodatage</dt><dd id="mqtt-last-event-time" data-placeholder>--</dd></div>
                  </dl>
                  <p id="mqtt-test-message" class="mt-3 small text-secondary" aria-live="polite"></p>
                </div>
              </div>
            </div>

            <!-- Configuration Form -->
            <div class="col-lg-8">
              <form id="mqtt-config-form" class="card">
                <div class="card-header d-flex flex-wrap align-items-center gap-2">
                  <h3 class="card-title mb-0">
                    <i class="ti ti-settings-cog me-2"></i>
                    Configuration de la passerelle MQTT
                  </h3>
                  <span id="mqtt-unsaved-badge" class="badge bg-warning text-dark ms-auto d-none">Modifications non sauvegardées</span>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="mqtt-scheme" class="form-label">Schéma</label>
                      <select
                        id="mqtt-scheme"
                        name="scheme"
                        class="form-select"
                        aria-describedby="mqtt-scheme-hint"
                      >
                        <option value="mqtt">mqtt</option>
                        <option value="mqtts">mqtts</option>
                      </select>
                      <div class="form-hint" id="mqtt-scheme-hint">Choisissez le protocole adapté au niveau de sécurité du broker.</div>
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-port" class="form-label">Port</label>
                      <input
                        id="mqtt-port"
                        name="port"
                        type="number"
                        class="form-control"
                        min="1"
                        max="65535"
                        required
                        aria-describedby="mqtt-port-hint mqtt-port-error"
                      >
                      <div class="form-hint" id="mqtt-port-hint">Port TCP utilisé par le broker (1 à 65&nbsp;535).</div>
                      <div class="invalid-feedback" aria-live="assertive" id="mqtt-port-error" data-feedback-for="port"></div>
                    </div>
                    <div class="col-12">
                      <label for="mqtt-host" class="form-label">Hôte</label>
                      <input
                        id="mqtt-host"
                        name="host"
                        type="text"
                        class="form-control"
                        required
                        aria-describedby="mqtt-host-hint"
                      >
                      <div class="form-hint" id="mqtt-host-hint">Nom d’hôte ou adresse IP du serveur MQTT.</div>
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-username" class="form-label">Utilisateur</label>
                      <input
                        id="mqtt-username"
                        name="username"
                        type="text"
                        class="form-control"
                        aria-describedby="mqtt-username-hint"
                      >
                      <div class="form-hint" id="mqtt-username-hint">Laissez vide si aucune authentification n’est requise.</div>
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-password" class="form-label">Mot de passe</label>
                      <div class="input-group">
                        <input
                          id="mqtt-password"
                          name="password"
                          type="password"
                          class="form-control"
                          autocomplete="current-password"
                          aria-describedby="mqtt-password-hint"
                        >
                        <button
                          type="button"
                          class="btn btn-outline-secondary"
                          id="mqtt-password-toggle"
                          aria-label="Afficher le mot de passe"
                          aria-pressed="false"
                        >
                          <i class="ti ti-eye" aria-hidden="true"></i>
                          <span class="visually-hidden password-toggle-label">Afficher le mot de passe</span>
                        </button>
                      </div>
                      <div class="form-hint mt-1" id="mqtt-password-hint">
                        Le mot de passe est enregistré en clair dans la mémoire NVS de l'appareil.
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-keepalive" class="form-label">Keepalive (s)</label>
                      <input
                        id="mqtt-keepalive"
                        name="keepalive"
                        type="number"
                        class="form-control"
                        min="0"
                        aria-describedby="mqtt-keepalive-hint mqtt-keepalive-error"
                      >
                      <div class="form-hint" id="mqtt-keepalive-hint">Intervalle en secondes avant l’envoi d’un paquet PINGREQ (0 pour désactiver).</div>
                      <div class="invalid-feedback" aria-live="assertive" id="mqtt-keepalive-error" data-feedback-for="keepalive"></div>
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-qos" class="form-label">QoS par défaut</label>
                      <input
                        id="mqtt-qos"
                        name="default_qos"
                        type="number"
                        class="form-control"
                        min="0"
                        max="2"
                        aria-describedby="mqtt-qos-hint mqtt-qos-error"
                      >
                      <div class="form-hint" id="mqtt-qos-hint">Niveau de QoS appliqué par défaut (0 à 2).</div>
                      <div class="invalid-feedback" aria-live="assertive" id="mqtt-qos-error" data-feedback-for="default_qos"></div>
                    </div>
                    <div class="col-12">
                      <div class="form-check form-switch">
                        <input
                          id="mqtt-retain"
                          name="retain"
                          type="checkbox"
                          class="form-check-input"
                          aria-describedby="mqtt-retain-hint"
                        >
                        <label class="form-check-label" for="mqtt-retain">Retenir l'état</label>
                      </div>
                      <div class="form-hint" id="mqtt-retain-hint">Conserve le dernier message publié afin qu’il soit délivré aux nouveaux abonnés.</div>
                    </div>
                  </div>

                  <fieldset class="mt-4 d-none" id="mqtt-tls-section" data-tls-field>
                    <legend class="small text-uppercase text-secondary">Options TLS</legend>
                    <div class="row g-3">
                      <div class="col-12">
                        <label for="mqtt-client-cert" class="form-label">Chemin du certificat client</label>
                        <input
                          id="mqtt-client-cert"
                          name="client_cert_path"
                          type="text"
                          class="form-control"
                          placeholder="/spiffs/client.crt"
                          autocomplete="off"
                          aria-describedby="mqtt-client-cert-hint"
                        >
                        <div class="form-hint" id="mqtt-client-cert-hint">Chemin du certificat client stocké sur l’appareil (SPIFFS).</div>
                      </div>
                      <div class="col-12">
                        <label for="mqtt-ca-cert" class="form-label">Chemin du certificat CA</label>
                        <input
                          id="mqtt-ca-cert"
                          name="ca_cert_path"
                          type="text"
                          class="form-control"
                          placeholder="/spiffs/ca.crt"
                          autocomplete="off"
                          aria-describedby="mqtt-ca-cert-hint"
                        >
                        <div class="form-hint" id="mqtt-ca-cert-hint">Certificat d’autorité permettant de valider le serveur distant.</div>
                      </div>
                      <div class="col-12">
                        <div class="form-check form-switch">
                          <input
                            id="mqtt-verify-hostname"
                            name="verify_hostname"
                            type="checkbox"
                            class="form-check-input"
                            checked
                            aria-describedby="mqtt-verify-hostname-hint"
                          >
                          <label class="form-check-label" for="mqtt-verify-hostname">
                            Valider le nom d'hôte du serveur
                          </label>
                        </div>
                        <div class="form-hint mt-1" id="mqtt-verify-hostname-hint">
                          Décochez uniquement si le certificat ne correspond pas à l'hôte configuré.
                        </div>
                      </div>
                    </div>
                  </fieldset>

                  <fieldset class="mt-4">
                    <legend class="small text-uppercase text-secondary">Topics personnalisés</legend>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="mqtt-status-topic" class="form-label">Statut</label>
                        <input
                          id="mqtt-status-topic"
                          name="status_topic"
                          type="text"
                          class="form-control"
                          aria-describedby="mqtt-status-topic-hint mqtt-status-topic-error"
                        >
                        <div class="form-hint" id="mqtt-status-topic-hint">Format attendu : <code>bms/&lt;identifiant&gt;/status</code>.</div>
                        <div class="invalid-feedback" aria-live="assertive" id="mqtt-status-topic-error" data-feedback-for="status_topic"></div>
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-metrics-topic" class="form-label">Mesures</label>
                        <input
                          id="mqtt-metrics-topic"
                          name="metrics_topic"
                          type="text"
                          class="form-control"
                          aria-describedby="mqtt-metrics-topic-hint mqtt-metrics-topic-error"
                        >
                        <div class="form-hint" id="mqtt-metrics-topic-hint">Format attendu : <code>bms/&lt;identifiant&gt;/metrics</code>.</div>
                        <div class="invalid-feedback" aria-live="assertive" id="mqtt-metrics-topic-error" data-feedback-for="metrics_topic"></div>
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-config-topic" class="form-label">Configuration</label>
                        <input
                          id="mqtt-config-topic"
                          name="config_topic"
                          type="text"
                          class="form-control"
                          aria-describedby="mqtt-config-topic-hint mqtt-config-topic-error"
                        >
                        <div class="form-hint" id="mqtt-config-topic-hint">Format attendu : <code>bms/&lt;identifiant&gt;/config</code>.</div>
                        <div class="invalid-feedback" aria-live="assertive" id="mqtt-config-topic-error" data-feedback-for="config_topic"></div>
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-can-raw-topic" class="form-label">CAN brut</label>
                        <input
                          id="mqtt-can-raw-topic"
                          name="can_raw_topic"
                          type="text"
                          class="form-control"
                          aria-describedby="mqtt-can-raw-topic-hint mqtt-can-raw-topic-error"
                        >
                        <div class="form-hint" id="mqtt-can-raw-topic-hint">Format attendu : <code>bms/&lt;identifiant&gt;/can/raw</code>.</div>
                        <div class="invalid-feedback" aria-live="assertive" id="mqtt-can-raw-topic-error" data-feedback-for="can_raw_topic"></div>
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-can-decoded-topic" class="form-label">CAN décodé</label>
                        <input
                          id="mqtt-can-decoded-topic"
                          name="can_decoded_topic"
                          type="text"
                          class="form-control"
                          aria-describedby="mqtt-can-decoded-topic-hint mqtt-can-decoded-topic-error"
                        >
                        <div class="form-hint" id="mqtt-can-decoded-topic-hint">Format attendu : <code>bms/&lt;identifiant&gt;/can/decoded</code>.</div>
                        <div class="invalid-feedback" aria-live="assertive" id="mqtt-can-decoded-topic-error" data-feedback-for="can_decoded_topic"></div>
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-can-ready-topic" class="form-label">CAN prêts</label>
                        <input
                          id="mqtt-can-ready-topic"
                          name="can_ready_topic"
                          type="text"
                          class="form-control"
                          aria-describedby="mqtt-can-ready-topic-hint mqtt-can-ready-topic-error"
                        >
                        <div class="form-hint" id="mqtt-can-ready-topic-hint">Format attendu : <code>bms/&lt;identifiant&gt;/can/ready</code>.</div>
                        <div class="invalid-feedback" aria-live="assertive" id="mqtt-can-ready-topic-error" data-feedback-for="can_ready_topic"></div>
                      </div>
                    </div>
                  </fieldset>
                </div>
                <div class="card-footer">
                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="ti ti-device-floppy me-2"></i>
                      Enregistrer la configuration
                    </button>
                    <button type="button" class="btn btn-outline-secondary w-100" id="mqtt-reset">
                      <i class="ti ti-arrow-back-up me-2"></i>
                      Réinitialiser
                    </button>
                  </div>
                  <p
                    id="mqtt-config-message"
                    class="mt-2 mb-0 small text-center"
                    role="status"
                    aria-live="polite"
                    aria-atomic="true"
                  ></p>
                </div>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script defer src="/assets/js/tabler.min.js"></script>
    <script type="module" src="/src/js/mqtt-config.js"></script>
  </body>
</html>
