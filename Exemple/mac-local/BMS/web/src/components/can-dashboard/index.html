<section id="tab-can-dashboard" class="tab-panel" aria-labelledby="tab-can-dashboard-label">
  <!-- KPI Row -->
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Occupation du bus</div>
          </div>
          <div class="d-flex align-items-baseline mt-2">
            <div class="h1 mb-0 me-2" id="can-dash-occupancy">0</div>
            <div class="text-secondary">%</div>
          </div>
          <div class="mt-2">
            <span class="text-muted small">Fenêtre:</span>
            <span class="text-secondary small" id="can-dash-occupancy-window">--</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Keepalive &amp; handshake</div>
          </div>
          <div class="mt-3">
            <span id="can-dash-keepalive-badge" class="badge status-badge status-badge--unknown">Inconnu</span>
          </div>
          <div class="mt-2">
            <span class="text-muted small">Dernier échange:</span>
            <span class="text-secondary small" id="can-dash-keepalive-latency">--</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Débit émission</div>
          </div>
          <div class="d-flex align-items-baseline mt-2">
            <div class="h1 mb-0 me-2" id="can-dash-tx-rate">0</div>
            <div class="text-secondary">tr/s</div>
          </div>
          <div class="mt-2 d-flex flex-column gap-1">
            <span class="text-muted small">Trames totales: <span class="text-secondary" id="can-dash-tx-total">0</span></span>
            <span class="text-muted small">Octets totaux: <span class="text-secondary" id="can-dash-tx-bytes">0</span></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="subheader">Débit réception</div>
          </div>
          <div class="d-flex align-items-baseline mt-2">
            <div class="h1 mb-0 me-2" id="can-dash-rx-rate">0</div>
            <div class="text-secondary">tr/s</div>
          </div>
          <div class="mt-2 d-flex flex-column gap-1">
            <span class="text-muted small">Trames totales: <span class="text-secondary" id="can-dash-rx-total">0</span></span>
            <span class="text-muted small">Octets totaux: <span class="text-secondary" id="can-dash-rx-bytes">0</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts & Bus state -->
  <div class="row g-3 mb-3">
    <div class="col-xxl-8">
      <div class="card h-100">
        <div class="card-header d-flex flex-wrap align-items-center gap-2">
          <h3 class="card-title mb-0">Analyse du trafic CAN</h3>
          <div class="d-flex flex-wrap gap-2 ms-auto">
            <label for="can-filter-source" class="visually-hidden">Type de trames</label>
            <select id="can-filter-source" class="form-select form-select-sm" aria-label="Filtrer le type de trames CAN">
              <option value="all" selected>Toutes les trames</option>
              <option value="raw">Brutes uniquement</option>
              <option value="decoded">Décodées uniquement</option>
            </select>
            <label for="can-filter-window" class="visually-hidden">Fenêtre temporelle</label>
            <select id="can-filter-window" class="form-select form-select-sm" aria-label="Fenêtre temporelle d'analyse">
              <option value="60">60 s</option>
              <option value="300" selected>5 min</option>
              <option value="900">15 min</option>
            </select>
            <button id="can-dash-refresh" class="btn btn-sm btn-outline-primary" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" /><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" /></svg>
              Actualiser
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <h4 class="card-subtitle text-secondary text-uppercase fs-6 mb-2">Heatmap des identifiants</h4>
            <div id="can-heatmap-chart" class="echart-container" role="img" aria-label="Heatmap des identifiants CAN"></div>
          </div>
          <div>
            <h4 class="card-subtitle text-secondary text-uppercase fs-6 mb-2">Débit par fenêtre</h4>
            <div id="can-throughput-chart" class="echart-container" role="img" aria-label="Histogramme des débits CAN"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xxl-4">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center">
          <h3 class="card-title mb-0">État du bus</h3>
          <span id="can-dash-bus-state-badge" class="badge status-badge ms-auto">Inconnu</span>
        </div>
        <div class="card-body">
          <dl class="status-kv">
            <div><dt>Dernière mise à jour</dt><dd id="can-dash-last-update">--</dd></div>
            <div><dt>Driver</dt><dd id="can-dash-driver-state">--</dd></div>
            <div><dt>État courant</dt><dd id="can-dash-bus-state-text">--</dd></div>
            <div><dt>Fenêtre analyse</dt><dd id="can-dash-bus-window">--</dd></div>
            <div><dt>Bus-off cumulés</dt><dd id="can-dash-bus-off-count">0</dd></div>
            <div><dt>Erreurs bus</dt><dd id="can-dash-bus-error-count">0</dd></div>
            <div><dt>Arbitrages perdus</dt><dd id="can-dash-arbitration-count">0</dd></div>
            <div><dt>Réceptions manquées</dt><dd id="can-dash-rx-missed-count">0</dd></div>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <!-- Tables Row -->
  <div class="row g-3 mb-3">
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="card-title mb-0">Compteurs d'erreurs</h3>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 260px; overflow-y: auto;">
            <table class="table table-vcenter card-table table-striped">
              <thead>
                <tr>
                  <th>Type</th>
                  <th class="text-end">Valeur</th>
                  <th class="text-end">Dernier changement</th>
                </tr>
              </thead>
              <tbody id="can-dash-errors-table">
                <tr>
                  <td colspan="3" class="text-muted text-center">Aucun compteur disponible</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="card-title mb-0">Trafic cumulé</h3>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 260px; overflow-y: auto;">
            <table class="table table-vcenter card-table table-striped">
              <thead>
                <tr>
                  <th>Mesure</th>
                  <th class="text-end">Valeur</th>
                </tr>
              </thead>
              <tbody id="can-dash-traffic-table">
                <tr>
                  <td colspan="2" class="text-muted text-center">Aucune donnée</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="card-title mb-0">Keepalive détaillé</h3>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 260px; overflow-y: auto;">
            <table class="table table-vcenter card-table table-striped">
              <tbody>
                <tr><th scope="row">Dernier TX</th><td class="text-end" id="can-dash-keepalive-last-tx">--</td></tr>
                <tr><th scope="row">Dernier RX</th><td class="text-end" id="can-dash-keepalive-last-rx">--</td></tr>
                <tr><th scope="row">Intervalle</th><td class="text-end" id="can-dash-keepalive-interval">--</td></tr>
                <tr><th scope="row">Timeout</th><td class="text-end" id="can-dash-keepalive-timeout">--</td></tr>
                <tr><th scope="row">Retry</th><td class="text-end" id="can-dash-keepalive-retry">--</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Events Row -->
  <div class="row g-3">
    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center">
          <h3 class="card-title mb-0">Événements récents</h3>
          <button id="can-dash-events-clear" class="btn btn-sm btn-outline-danger ms-auto" type="button">Effacer</button>
        </div>
        <div class="card-body p-0">
          <div style="max-height: 320px; overflow-y: auto;">
            <div id="can-dash-events" class="list-group list-group-flush">
              <div class="list-group-item text-muted text-center">Aucun événement</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-header">
          <h3 class="card-title mb-0">Dernières observations</h3>
        </div>
        <div class="card-body">
          <dl class="status-kv">
            <div><dt>Dernière trame TX</dt><dd id="can-dash-last-tx">--</dd></div>
            <div><dt>Dernière trame RX</dt><dd id="can-dash-last-rx">--</dd></div>
            <div><dt>Dernière erreur</dt><dd id="can-dash-last-error">--</dd></div>
            <div><dt>Erreur détectée</dt><dd id="can-dash-last-error-time">--</dd></div>
          </dl>
        </div>
      </div>
    </div>
  </div>
</section>
