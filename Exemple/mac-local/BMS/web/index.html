<!DOCTYPE html>
<html lang="fr" data-partials-loaded="false">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TinyBMS Web Gateway</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />

    <!-- 1. Tabler CSS + Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css">

    <style> 
        #tab-config .accordion-button {color: #e9ecef !important; background-color: #1c1f23 !important;}
        #tab-config .accordion-body { color: #e9ecef !important;}
        #tab-config .form-label { color: #e9ecef !important; } 
    </style>

    <!-- Tabler Icons via CDN (économise 4.3M de stockage sur ESP32) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/tabler-icons.min.css" />

    <!-- 2. Styles personnalisés -->
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="theme-dark">
    <div id="app" class="page">
      <div data-partial="/src/layout/header.html"></div>
      <div data-partial="/src/layout/main.html"></div>
    </div>
    
    <script defer src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>

    <!-- Chargement des partials -->
    <script type="module">
      const DEFAULT_PARTIAL_BASE = document.baseURI;

      async function loadPartials() {
        let placeholders = Array.from(document.querySelectorAll('[data-partial]'));

        while (placeholders.length) {
          await Promise.all(
            placeholders.map(async (placeholder) => {
              const url = placeholder.getAttribute('data-partial');
              if (!url) return;

              const base = placeholder.getAttribute('data-partial-base') ?? DEFAULT_PARTIAL_BASE;
              const resolvedUrl = new URL(url, base).toString();

              try {
                const response = await fetch(resolvedUrl);
                if (!response.ok) throw new Error(`Impossible de charger ${resolvedUrl}`);

                const markup = await response.text();
                const template = document.createElement('template');
                template.innerHTML = markup.trim();

                const partialBase = resolvedUrl.slice(0, resolvedUrl.lastIndexOf('/') + 1);
                template.content.querySelectorAll('[data-partial]').forEach((node) => {
                  if (!node.hasAttribute('data-partial-base')) {
                    node.setAttribute('data-partial-base', partialBase);
                  }
                });

                placeholder.replaceWith(template.content);
              } catch (error) {
                console.error(error);
                placeholder.removeAttribute('data-partial');
              }
            })
          );

          placeholders = Array.from(document.querySelectorAll('[data-partial]'));
        }

        document.documentElement.dataset.partialsLoaded = 'true';
        document.dispatchEvent(new CustomEvent('partials-loaded'));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadPartials);
      } else {
        loadPartials();
      }
    </script>

    <!-- Load ECharts before dashboard.js so it's available globally -->
    <!-- Using CDN version (full) instead of local simple version which lacks gauge component -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <script type="module" src="/dashboard.js"></script>
  </body>
</html>
